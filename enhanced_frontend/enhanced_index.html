<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¢å¼ºå¤šç”¨æˆ·AIåä½œå¼€å‘å¹³å°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #fff, #f0f8ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 5px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            margin: 0 5px;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .user-stats {
            display: flex;
            gap: 20px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4ade80;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
        }

        .input-group input::placeholder,
        .input-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .project-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .project-title {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .project-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .status-completed { background: #22c55e; }
        .status-pending { background: #f59e0b; }
        .status-error { background: #ef4444; }
        .status-deploying { background: #3b82f6; }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            transition: width 0.3s ease;
        }

        .project-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .logs-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .log-entry {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }

        .log-timestamp {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .payment-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .payment-option {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .payment-option:hover,
        .payment-option.selected {
            border-color: #4ade80;
            transform: translateY(-5px);
        }

        .share-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }

        .share-btn {
            padding: 15px;
            border-radius: 50%;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .share-btn:hover {
            transform: scale(1.2);
        }

        .share-wechat { background: #07c160; }
        .share-weibo { background: #e6162d; }
        .share-qq { background: #12b7f5; }

        .hidden { display: none !important; }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        .notification.success { background: #22c55e; }
        .notification.error { background: #ef4444; }
        .notification.info { background: #3b82f6; }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .document-editor {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .document-editor textarea {
            min-height: 200px;
            resize: vertical;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                margin: 2px;
                padding: 8px 16px;
                font-size: 0.9rem;
            }

            .user-stats {
                flex-wrap: wrap;
                gap: 10px;
            }

            .project-actions {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="header">
            <h1><i class="fas fa-robot"></i> å¢å¼ºå¤šç”¨æˆ·AIåä½œå¼€å‘å¹³å°</h1>
            <p>ä½“éªŒå®Œæ•´çš„AIé©±åŠ¨å¼€å‘æµç¨‹ - æ–‡æ¡£ç¡®è®¤ã€å‰ç«¯é¢„è§ˆã€ä¸€é”®éƒ¨ç½²</p>
        </div>

        <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
        <div class="user-info">
            <div>
                <h3 id="userName">æ¸¸å®¢æ¨¡å¼</h3>
                <p id="userTier">åŸºç¡€ç‰ˆç”¨æˆ·</p>
            </div>
            <div class="user-stats">
                <div class="stat">
                    <div class="stat-value" id="apiBalance">100</div>
                    <div class="stat-label">APIä½™é¢</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="projectCount">0</div>
                    <div class="stat-label">é¡¹ç›®æ•°é‡</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="invitationCount">0</div>
                    <div class="stat-label">é‚€è¯·å¥–åŠ±</div>
                </div>
            </div>
        </div>

        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('develop')">
                <i class="fas fa-code"></i> AIå¼€å‘
            </div>
            <div class="tab" onclick="switchTab('projects')">
                <i class="fas fa-folder"></i> é¡¹ç›®ç®¡ç†
            </div>
            <div class="tab" onclick="switchTab('recharge')">
                <i class="fas fa-credit-card"></i> å……å€¼ä¸­å¿ƒ
            </div>
            <div class="tab" onclick="switchTab('share')">
                <i class="fas fa-share"></i> åˆ†äº«å¥–åŠ±
            </div>
            <div class="tab" onclick="switchTab('account')">
                <i class="fas fa-user"></i> è´¦æˆ·ä¸­å¿ƒ
            </div>
        </div>

        <!-- AIå¼€å‘æ ‡ç­¾é¡µ -->
        <div id="develop" class="tab-content active">
            <h2><i class="fas fa-magic"></i> AIåä½œå¼€å‘</h2>
            
            <!-- æ¨¡å¼é€‰æ‹© -->
            <div class="input-group">
                <label>å¼€å‘æ¨¡å¼</label>
                <select id="developMode">
                    <option value="true">æµ‹è¯•æ¨¡å¼ï¼ˆå¿«é€Ÿï¼Œ1é…é¢ï¼‰</option>
                    <option value="false">çœŸå®æ¨¡å¼ï¼ˆå®Œæ•´AIï¼Œ10é…é¢ï¼‰</option>
                </select>
            </div>

            <!-- éœ€æ±‚è¾“å…¥ -->
            <div class="input-group">
                <label>é¡¹ç›®éœ€æ±‚æè¿°</label>
                <textarea id="requirementInput" rows="6" 
                          placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„é¡¹ç›®éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šæˆ‘éœ€è¦ä¸€ä¸ªç®€å•çš„ç¤¾äº¤å¹³å°ï¼ŒåŒ…å«ç”¨æˆ·æ³¨å†Œç™»å½•ã€å‘å¸ƒåŠ¨æ€ã€å…³æ³¨å¥½å‹ã€ç‚¹èµè¯„è®ºç­‰åŠŸèƒ½ã€‚è¦æ±‚ç•Œé¢ç®€æ´ç¾è§‚ï¼Œæ”¯æŒç§»åŠ¨ç«¯è®¿é—®..."></textarea>
            </div>

            <button id="startButton" class="btn btn-primary" onclick="startAIDevelopment()">
                <i class="fas fa-rocket"></i> å¯åŠ¨AIåä½œå¼€å‘
            </button>

            <!-- å¼€å‘è¿›åº¦ -->
            <div id="progressSection" class="hidden">
                <h3>å¼€å‘è¿›åº¦</h3>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
                <p id="progressText">å‡†å¤‡å¼€å§‹...</p>

                <!-- AIæ—¥å¿— -->
                <div id="logsContainer" class="logs-container">
                    <h4>AIåä½œæ—¥å¿—</h4>
                    <div id="aiLogs"></div>
                </div>
            </div>
        </div>

        <!-- é¡¹ç›®ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="projects" class="tab-content">
            <h2><i class="fas fa-folder-open"></i> é¡¹ç›®ç®¡ç†</h2>
            <div id="projectsList">
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>

        <!-- å……å€¼ä¸­å¿ƒæ ‡ç­¾é¡µ -->
        <div id="recharge" class="tab-content">
            <h2><i class="fas fa-credit-card"></i> å……å€¼ä¸­å¿ƒ</h2>
            
            <div class="payment-options">
                <div class="payment-option" onclick="selectPaymentOption('basic')">
                    <h3>åŸºç¡€å¥—é¤</h3>
                    <div class="stat-value">ï¿¥19</div>
                    <p>100ä¸ªAPIé…é¢</p>
                    <small>é€‚åˆå°å‹é¡¹ç›®</small>
                </div>
                <div class="payment-option" onclick="selectPaymentOption('pro')">
                    <h3>ä¸“ä¸šå¥—é¤</h3>
                    <div class="stat-value">ï¿¥49</div>
                    <p>300ä¸ªAPIé…é¢</p>
                    <small>é€‚åˆä¸­å‹é¡¹ç›®</small>
                </div>
                <div class="payment-option" onclick="selectPaymentOption('enterprise')">
                    <h3>ä¼ä¸šå¥—é¤</h3>
                    <div class="stat-value">ï¿¥99</div>
                    <p>800ä¸ªAPIé…é¢</p>
                    <small>é€‚åˆå¤§å‹é¡¹ç›®</small>
                </div>
            </div>

            <div id="paymentMethods" class="hidden">
                <h3>é€‰æ‹©æ”¯ä»˜æ–¹å¼</h3>
                <div style="display: flex; gap: 20px; justify-content: center; margin: 20px 0;">
                    <button class="btn btn-secondary" onclick="processPayment('wechat')">
                        <i class="fab fa-weixin"></i> å¾®ä¿¡æ”¯ä»˜
                    </button>
                    <button class="btn btn-secondary" onclick="processPayment('alipay')">
                        <i class="fab fa-alipay"></i> æ”¯ä»˜å®
                    </button>
                </div>
            </div>

            <div id="rechargeHistory">
                <h3>å……å€¼è®°å½•</h3>
                <div id="rechargeRecords">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- åˆ†äº«å¥–åŠ±æ ‡ç­¾é¡µ -->
        <div id="share" class="tab-content">
            <h2><i class="fas fa-gift"></i> åˆ†äº«å¥–åŠ±</h2>
            
            <div style="text-align: center; margin: 30px 0;">
                <h3>æˆ‘çš„é‚€è¯·ç </h3>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin: 20px 0;">
                    <span id="invitationCode" style="font-size: 1.5rem; font-weight: bold;">åŠ è½½ä¸­...</span>
                    <button class="btn btn-secondary" onclick="copyInvitationCode()" style="margin-left: 15px;">
                        <i class="fas fa-copy"></i> å¤åˆ¶
                    </button>
                </div>
                <p>é‚€è¯·æ–°ç”¨æˆ·æ³¨å†Œï¼Œè·å¾—30ä¸ªAPIé…é¢å¥–åŠ±</p>
                <p>å¥½å‹å……å€¼æ—¶ï¼Œæ‚¨è¿˜èƒ½è·å¾—å…¶å……å€¼é…é¢çš„15%å¥–åŠ±</p>
            </div>

            <div class="share-buttons">
                <a href="#" class="share-btn share-wechat" onclick="shareToWeChat()">
                    <i class="fab fa-weixin"></i>
                </a>
                <a href="#" class="share-btn share-weibo" onclick="shareToWeibo()">
                    <i class="fab fa-weibo"></i>
                </a>
                <a href="#" class="share-btn share-qq" onclick="shareToQQ()">
                    <i class="fab fa-qq"></i>
                </a>
            </div>

            <div id="shareHistory">
                <h3>åˆ†äº«è®°å½•</h3>
                <div id="shareRecords">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- è´¦æˆ·ä¸­å¿ƒæ ‡ç­¾é¡µ -->
        <div id="account" class="tab-content">
            <h2><i class="fas fa-user-cog"></i> è´¦æˆ·ä¸­å¿ƒ</h2>
            
            <div class="input-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="usernameInput" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            </div>
            
            <div class="input-group">
                <label>é‚®ç®±ï¼ˆå¯é€‰ï¼‰</label>
                <input type="email" id="emailInput" placeholder="è¯·è¾“å…¥é‚®ç®±">
            </div>

            <div class="input-group">
                <label>é‚€è¯·ç ï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="inviterCodeInput" placeholder="å¦‚æœæœ‰æœ‹å‹é‚€è¯·ç ï¼Œè¯·è¾“å…¥">
            </div>

            <button class="btn btn-primary" onclick="login()">
                <i class="fas fa-sign-in-alt"></i> ç™»å½•/æ³¨å†Œ
            </button>

            <div id="userDetails" class="hidden" style="margin-top: 30px;">
                <h3>è´¦æˆ·è¯¦æƒ…</h3>
                <div id="userStats">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div id="documentModal" class="modal">
        <div class="modal-content">
            <h3>é¡¹ç›®æ–‡æ¡£ç¡®è®¤</h3>
            <div class="document-editor">
                <textarea id="documentContent" rows="15" placeholder="é¡¹ç›®æ–‡æ¡£å†…å®¹..."></textarea>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="confirmDocument()">ç¡®è®¤æ–‡æ¡£</button>
                <button class="btn btn-secondary" onclick="modifyDocument()">ä¿®æ”¹æ–‡æ¡£</button>
                <button class="btn btn-danger" onclick="closeModal('documentModal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <div id="frontendModal" class="modal">
        <div class="modal-content">
            <h3>å‰ç«¯ç•Œé¢é¢„è§ˆ</h3>
            <iframe id="frontendPreview" width="100%" height="400px" style="border: none; border-radius: 10px;"></iframe>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="confirmFrontend()">ç¡®è®¤ç•Œé¢</button>
                <button class="btn btn-secondary" onclick="modifyFrontend()">ä¿®æ”¹ç•Œé¢</button>
                <button class="btn btn-danger" onclick="closeModal('frontendModal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentUserId = null;
        let currentProject = null;
        let selectedPaymentPlan = null;
        let ws = null;

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯
            const savedUserId = localStorage.getItem('userId');
            if (savedUserId) {
                currentUserId = savedUserId;
                loadUserData();
                connectWebSocket();
            }
        });

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾é¡µçš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µå†…å®¹
            document.getElementById(tabName).classList.add('active');
            
            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾é¡µ
            event.target.closest('.tab').classList.add('active');

            // åŠ è½½å¯¹åº”çš„æ•°æ®
            switch(tabName) {
                case 'projects':
                    loadProjects();
                    break;
                case 'recharge':
                    loadRechargeRecords();
                    break;
                case 'share':
                    loadShareData();
                    break;
                case 'account':
                    if (currentUserId) {
                        loadUserDetails();
                    }
                    break;
            }
        }

        // ç™»å½•/æ³¨å†Œ
        async function login() {
            const username = document.getElementById('usernameInput').value.trim();
            const email = document.getElementById('emailInput').value.trim();
            const inviterCode = document.getElementById('inviterCodeInput').value.trim();

            if (!username) {
                showNotification('è¯·è¾“å…¥ç”¨æˆ·å', 'error');
                return;
            }

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        email: email,
                        inviter_code: inviterCode
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    currentUserId = result.user_id;
                    localStorage.setItem('userId', currentUserId);
                    showNotification('ç™»å½•æˆåŠŸï¼', 'success');
                    
                    // æ›´æ–°ç•Œé¢
                    document.getElementById('userName').textContent = username;
                    loadUserData();
                    connectWebSocket();
                } else {
                    showNotification(result.detail || 'ç™»å½•å¤±è´¥', 'error');
                }
            } catch (error) {
                showNotification('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // è¿æ¥WebSocket
        function connectWebSocket() {
            if (!currentUserId) return;

            ws = new WebSocket(`ws://localhost:8892/ws?user_id=${currentUserId}`);
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            ws.onclose = function() {
                // è‡ªåŠ¨é‡è¿
                setTimeout(connectWebSocket, 3000);
            };
        }

        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'ai_log':
                    addAILog(data);
                    break;
                case 'project_ready_for_review':
                    handleProjectReadyForReview(data);
                    break;
                case 'project_completed':
                    handleProjectCompleted(data);
                    break;
            }
        }

        // å¯åŠ¨AIå¼€å‘
        async function startAIDevelopment() {
            const requirement = document.getElementById('requirementInput').value.trim();
            const testMode = document.getElementById('developMode').value === 'true';

            if (!requirement) {
                showNotification('è¯·è¾“å…¥é¡¹ç›®éœ€æ±‚æè¿°', 'error');
                return;
            }

            if (!currentUserId) {
                showNotification('è¯·å…ˆç™»å½•', 'error');
                switchTab('account');
                return;
            }

            const button = document.getElementById('startButton');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AIåä½œå¼€å‘ä¸­...';

            // æ˜¾ç¤ºè¿›åº¦åŒºåŸŸ
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('aiLogs').innerHTML = '';
            updateProgress(0, 'å¼€å§‹AIåä½œå¼€å‘...');

            try {
                const response = await fetch('/api/start-integrated-ai-development', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        requirement: requirement,
                        test_mode: testMode
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showNotification(result.message, 'success');
                    updateProgress(10, 'AIå¼€å‘æµç¨‹å·²å¯åŠ¨...');
                } else {
                    throw new Error(result.detail || 'AIå¼€å‘å¯åŠ¨å¤±è´¥');
                }
            } catch (error) {
                showNotification(error.message, 'error');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-rocket"></i> å¯åŠ¨AIåä½œå¼€å‘';
            }
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(percentage, text) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = text;
        }

        // æ·»åŠ AIæ—¥å¿—
        function addAILog(data) {
            const logsContainer = document.getElementById('aiLogs');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <div class="log-timestamp">${new Date(data.timestamp).toLocaleTimeString()}</div>
                <strong>[${data.ai_name}]</strong> ${data.action}: ${data.message}
                ${data.tokens_used ? `<small style="float: right;">Token: ${data.tokens_used}</small>` : ''}
            `;
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;

            // æ›´æ–°è¿›åº¦
            const progressMap = {
                'éœ€æ±‚åˆ†æ': 20,
                'ä»£ç ç”Ÿæˆ': 50,
                'è´¨é‡æ£€æŸ¥': 70,
                'æµ‹è¯•éªŒè¯': 85,
                'é¡¹ç›®å®Œæˆ': 100,
                'ä»£ç ç”Ÿæˆå®Œæˆ': 90
            };
            
            const progress = progressMap[data.action] || 0;
            if (progress > 0) {
                updateProgress(progress, data.message);
            }
        }

        // å¤„ç†é¡¹ç›®å‡†å¤‡å®¡æŸ¥
        function handleProjectReadyForReview(data) {
            currentProject = data.project;
            updateProgress(100, 'é¡¹ç›®ç”Ÿæˆå®Œæˆï¼Œè¯·ç¡®è®¤æ–‡æ¡£å’Œå‰ç«¯');
            
            // é‡ç½®å¼€å‘æŒ‰é’®
            const button = document.getElementById('startButton');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-rocket"></i> å¯åŠ¨AIåä½œå¼€å‘';
            
            showNotification('é¡¹ç›®ç”Ÿæˆå®Œæˆï¼è¯·ç¡®è®¤æ–‡æ¡£å’Œå‰ç«¯ç•Œé¢', 'success');
            
            // æ˜¾ç¤ºç¡®è®¤æŒ‰é’®
            addProjectActions(data);
        }

        // æ·»åŠ é¡¹ç›®æ“ä½œæŒ‰é’®
        function addProjectActions(data) {
            const logsContainer = document.getElementById('aiLogs');
            const actionsDiv = document.createElement('div');
            actionsDiv.innerHTML = `
                <div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                    <h4>é¡¹ç›®æ“ä½œ</h4>
                    <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="reviewDocument('${data.project.id}')">
                            <i class="fas fa-file-alt"></i> æŸ¥çœ‹æ–‡æ¡£
                        </button>
                        <button class="btn btn-secondary" onclick="previewFrontend('${data.project.id}')">
                            <i class="fas fa-eye"></i> é¢„è§ˆå‰ç«¯
                        </button>
                        <button class="btn btn-primary" onclick="deployProject('${data.project.id}')">
                            <i class="fas fa-cloud-upload-alt"></i> éƒ¨ç½²é¡¹ç›®
                        </button>
                    </div>
                </div>
            `;
            logsContainer.appendChild(actionsDiv);
        }

        // æŸ¥çœ‹æ–‡æ¡£
        function reviewDocument(projectId) {
            if (!currentProject) return;
            
            document.getElementById('documentContent').value = currentProject.document_content || 'åŠ è½½æ–‡æ¡£å†…å®¹...';
            document.getElementById('documentModal').style.display = 'flex';
        }

        // é¢„è§ˆå‰ç«¯
        function previewFrontend(projectId) {
            if (!currentProject) return;
            
            const previewUrl = currentProject.frontend_preview_url;
            document.getElementById('frontendPreview').src = previewUrl;
            document.getElementById('frontendModal').style.display = 'flex';
        }

        // ç¡®è®¤æ–‡æ¡£
        async function confirmDocument() {
            if (!currentProject) return;

            try {
                const response = await fetch('/api/review-document', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_id: currentProject.id,
                        user_id: currentUserId,
                        document_content: document.getElementById('documentContent').value,
                        modification_type: 'confirm'
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showNotification('æ–‡æ¡£å·²ç¡®è®¤', 'success');
                    closeModal('documentModal');
                    currentProject.document_confirmed = true;
                } else {
                    showNotification(result.message || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                showNotification('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // ä¿®æ”¹æ–‡æ¡£
        async function modifyDocument() {
            const feedback = prompt('è¯·è¾“å…¥æ‚¨å¸Œæœ›ä¿®æ”¹çš„å†…å®¹ï¼š');
            if (!feedback) return;

            try {
                const response = await fetch('/api/review-document', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_id: currentProject.id,
                        user_id: currentUserId,
                        document_content: document.getElementById('documentContent').value,
                        modification_type: 'modify',
                        feedback: feedback
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('documentContent').value = result.document;
                    showNotification('æ–‡æ¡£å·²æ ¹æ®æ‚¨çš„åé¦ˆè¿›è¡Œä¿®æ”¹', 'success');
                } else {
                    showNotification(result.message || 'ä¿®æ”¹å¤±è´¥', 'error');
                }
            } catch (error) {
                showNotification('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // ç¡®è®¤å‰ç«¯
        async function confirmFrontend() {
            if (!currentProject) return;

            try {
                const response = await fetch('/api/review-frontend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_id: currentProject.id,
                        user_id: currentUserId,
                        preview_url: currentProject.frontend_preview_url,
                        modification_type: 'confirm'
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showNotification('å‰ç«¯ç•Œé¢å·²ç¡®è®¤', 'success');
                    closeModal('frontendModal');
                    currentProject.frontend_confirmed = true;
                } else {
                    showNotification(result.message || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                showNotification('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // ä¿®æ”¹å‰ç«¯
        async function modifyFrontend() {
            const feedback = prompt('è¯·è¾“å…¥æ‚¨å¸Œæœ›ä¿®æ”¹çš„å‰ç«¯å†…å®¹ï¼ˆå¦‚é¢œè‰²ã€å¸ƒå±€ç­‰ï¼‰ï¼š');
            if (!feedback) return;

            try {
                const response = await fetch('/api/review-frontend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_id: currentProject.id,
                        user_id: currentUserId,
                        preview_url: currentProject.frontend_preview_url,
                        modification_type: 'modify',
                        feedback: feedback
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    // åˆ·æ–°é¢„è§ˆ
                    document.getElementById('frontendPreview').src = result.preview_url + '?' + Date.now();
                    showNotification('å‰ç«¯ç•Œé¢å·²æ ¹æ®æ‚¨çš„åé¦ˆè¿›è¡Œä¿®æ”¹', 'success');
                    currentProject.frontend_preview_url = result.preview_url;
                } else {
                    showNotification(result.message || 'ä¿®æ”¹å¤±è´¥', 'error');
                }
            } catch (error) {
                showNotification('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // éƒ¨ç½²é¡¹ç›®
        async function deployProject(projectId) {
            const deploymentType = 'docker'; // é»˜è®¤ä½¿ç”¨Dockeréƒ¨ç½²

            try {
                const response = await fetch('/api/deploy-project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_id: projectId,
                        user_id: currentUserId,
                        deployment_type: deploymentType
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showNotification('é¡¹ç›®éƒ¨ç½²æˆåŠŸï¼', 'success');
                    // æ˜¾ç¤ºéƒ¨ç½²é“¾æ¥
                    const deploymentInfo = document.createElement('div');
                    deploymentInfo.innerHTML = `
                        <div style="margin: 20px 0; padding: 15px; background: rgba(34, 197, 94, 0.2); border-radius: 10px;">
                            <h4>ğŸ‰ éƒ¨ç½²æˆåŠŸï¼</h4>
                            <p>è®¿é—®é“¾æ¥: <a href="${result.deployment_url}" target="_blank" style="color: #4ade80;">${result.deployment_url}</a></p>
                            <p>${result.access_instructions}</p>
                        </div>
                    `;
                    document.getElementById('aiLogs').appendChild(deploymentInfo);
                } else {
                    showNotification(result.message || 'éƒ¨ç½²å¤±è´¥', 'error');
                }
            } catch (error) {
                showNotification('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // é€‰æ‹©æ”¯ä»˜å¥—é¤
        function selectPaymentPlan(plan) {
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.closest('.payment-option').classList.add('selected');
            
            selectedPaymentPlan = plan;
            document.getElementById('paymentMethods').classList.remove('hidden');
        }

        // å¤„ç†æ”¯ä»˜
        async function processPayment(method) {
            if (!selectedPaymentPlan) {
                showNotification('è¯·å…ˆé€‰æ‹©å¥—é¤', 'error');
                return;
            }

            const plans = {
                basic: { amount: 19, quota: 100 },
                pro: { amount: 49, quota: 300 },
                enterprise: { amount: 99, quota: 800 }
            };

            const plan = plans[selectedPaymentPlan];

            try {
                const response = await fetch('/api/recharge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        amount: plan.amount,
                        api_quota: plan.quota,
                        payment_method: method
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showNotification(`å……å€¼æˆåŠŸï¼è·å¾—${plan.quota}ä¸ªAPIé…é¢`, 'success');
                    loadUserData(); // åˆ·æ–°ç”¨æˆ·æ•°æ®
                    loadRechargeRecords(); // åˆ·æ–°å……å€¼è®°å½•
                } else {
                    showNotification(result.message || 'å……å€¼å¤±è´¥', 'error');
                }
            } catch (error) {
                showNotification('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // åˆ†äº«åŠŸèƒ½
        async function shareToWeChat() {
            await createShareRecord('platform', 'wechat');
            showNotification('åˆ†äº«æˆåŠŸï¼è·å¾—5ä¸ªAPIé…é¢å¥–åŠ±', 'success');
        }

        async function shareToWeibo() {
            await createShareRecord('platform', 'weibo');
            showNotification('åˆ†äº«æˆåŠŸï¼è·å¾—5ä¸ªAPIé…é¢å¥–åŠ±', 'success');
        }

        async function shareToQQ() {
            await createShareRecord('platform', 'qq');
            showNotification('åˆ†äº«æˆåŠŸï¼è·å¾—5ä¸ªAPIé…é¢å¥–åŠ±', 'success');
        }

        async function createShareRecord(shareType, platform) {
            try {
                const response = await fetch('/api/share', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        share_type: shareType,
                        share_platform: platform,
                        share_content: 'åˆ†äº«AIåä½œå¼€å‘å¹³å°'
                    })
                });

                if (response.ok) {
                    loadUserData(); // åˆ·æ–°ç”¨æˆ·æ•°æ®
                    loadShareData(); // åˆ·æ–°åˆ†äº«æ•°æ®
                }
            } catch (error) {
                console.error('åˆ†äº«è®°å½•åˆ›å»ºå¤±è´¥:', error);
            }
        }

        // å¤åˆ¶é‚€è¯·ç 
        function copyInvitationCode() {
            const invitationCode = document.getElementById('invitationCode').textContent;
            navigator.clipboard.writeText(invitationCode).then(() => {
                showNotification('é‚€è¯·ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            });
        }

        // åŠ è½½ç”¨æˆ·æ•°æ®
        async function loadUserData() {
            if (!currentUserId) return;

            try {
                const response = await fetch(`/api/user-stats/${currentUserId}`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('userName').textContent = data.user.username;
                    document.getElementById('userTier').textContent = data.user.subscription_tier + 'ç‰ˆç”¨æˆ·';
                    document.getElementById('apiBalance').textContent = data.user.api_balance;
                    document.getElementById('projectCount').textContent = data.projects.total;
                    document.getElementById('invitationCount').textContent = data.user.total_rewards;
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
            }
        }

        // åŠ è½½é¡¹ç›®åˆ—è¡¨
        async function loadProjects() {
            if (!currentUserId) return;

            try {
                const response = await fetch(`/api/user-projects/${currentUserId}`);
                const projects = await response.json();
                
                const projectsList = document.getElementById('projectsList');
                if (projects.length === 0) {
                    projectsList.innerHTML = '<p>æš‚æ— é¡¹ç›®ï¼Œå¿«å»åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªAIé¡¹ç›®å§ï¼</p>';
                    return;
                }

                projectsList.innerHTML = projects.map(project => `
                    <div class="project-card">
                        <div class="project-header">
                            <div class="project-title">${project.name}</div>
                            <div class="project-status ${getStatusClass(project.status)}">${project.status}</div>
                        </div>
                        <p>${project.description}</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${project.completion_percentage}%"></div>
                        </div>
                        <p>å®Œæˆåº¦: ${project.completion_percentage}% | æ–‡ä»¶æ•°: ${project.files_count}</p>
                        ${project.deployment_url ? `<p>è®¿é—®é“¾æ¥: <a href="${project.deployment_url}" target="_blank">${project.deployment_url}</a></p>` : ''}
                        <div class="project-actions">
                            ${!project.document_confirmed ? `<button class="btn btn-secondary" onclick="reviewDocument('${project.id}')">ç¡®è®¤æ–‡æ¡£</button>` : ''}
                            ${!project.frontend_confirmed ? `<button class="btn btn-secondary" onclick="previewFrontend('${project.id}')">ç¡®è®¤å‰ç«¯</button>` : ''}
                            ${project.deployment_status === 'æœªéƒ¨ç½²' && project.document_confirmed && project.frontend_confirmed ? 
                              `<button class="btn btn-primary" onclick="deployProject('${project.id}')">éƒ¨ç½²é¡¹ç›®</button>` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½é¡¹ç›®å¤±è´¥:', error);
            }
        }

        // è·å–çŠ¶æ€æ ·å¼ç±»
        function getStatusClass(status) {
            const statusMap = {
                'å·²å®Œæˆ': 'status-completed',
                'å¾…ç¡®è®¤æ–‡æ¡£': 'status-pending',
                'å¾…ç¡®è®¤å‰ç«¯': 'status-pending',
                'è¿›è¡Œä¸­': 'status-pending',
                'é”™è¯¯': 'status-error',
                'éƒ¨ç½²ä¸­': 'status-deploying'
            };
            return statusMap[status] || 'status-pending';
        }

        // åŠ è½½å……å€¼è®°å½•
        async function loadRechargeRecords() {
            if (!currentUserId) return;

            try {
                const response = await fetch(`/api/recharge-records/${currentUserId}`);
                const records = await response.json();
                
                const recordsDiv = document.getElementById('rechargeRecords');
                if (records.length === 0) {
                    recordsDiv.innerHTML = '<p>æš‚æ— å……å€¼è®°å½•</p>';
                    return;
                }

                recordsDiv.innerHTML = records.map(record => `
                    <div class="project-card">
                        <div class="project-header">
                            <div>ï¿¥${record.amount} - ${record.api_quota}é…é¢</div>
                            <div class="project-status ${record.payment_status === 'success' ? 'status-completed' : 'status-pending'}">
                                ${record.payment_status === 'success' ? 'æˆåŠŸ' : 'å¤„ç†ä¸­'}
                            </div>
                        </div>
                        <p>æ”¯ä»˜æ–¹å¼: ${record.payment_method}</p>
                        <p>æ—¶é—´: ${new Date(record.created_at).toLocaleString()}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½å……å€¼è®°å½•å¤±è´¥:', error);
            }
        }

        // åŠ è½½åˆ†äº«æ•°æ®
        async function loadShareData() {
            if (!currentUserId) return;

            try {
                // åŠ è½½é‚€è¯·ç»Ÿè®¡
                const invitationResponse = await fetch(`/api/invitation-stats/${currentUserId}`);
                const invitationData = await invitationResponse.json();
                
                document.getElementById('invitationCode').textContent = invitationData.invitation_code || 'åŠ è½½ä¸­...';

                // åŠ è½½åˆ†äº«è®°å½•
                const shareResponse = await fetch(`/api/share-records/${currentUserId}`);
                const shareRecords = await shareResponse.json();
                
                const recordsDiv = document.getElementById('shareRecords');
                if (shareRecords.length === 0) {
                    recordsDiv.innerHTML = '<p>æš‚æ— åˆ†äº«è®°å½•</p>';
                    return;
                }

                recordsDiv.innerHTML = shareRecords.map(record => `
                    <div class="project-card">
                        <div class="project-header">
                            <div>åˆ†äº«åˆ°${record.share_platform}</div>
                            <div class="project-status status-completed">+${record.reward_quota}é…é¢</div>
                        </div>
                        <p>åˆ†äº«å†…å®¹: ${record.share_content}</p>
                        <p>æ—¶é—´: ${new Date(record.created_at).toLocaleString()}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½åˆ†äº«æ•°æ®å¤±è´¥:', error);
            }
        }

        // åŠ è½½ç”¨æˆ·è¯¦æƒ…
        function loadUserDetails() {
            // è¿™é‡Œå¯ä»¥åŠ è½½æ›´è¯¦ç»†çš„ç”¨æˆ·ä¿¡æ¯
            document.getElementById('userDetails').classList.remove('hidden');
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>